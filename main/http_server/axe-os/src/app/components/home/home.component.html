<ng-template #noValue>--</ng-template>

<ng-container *ngIf="info$ | async as info">
    <ng-container *ngFor="let message of messages">
        <p-message
            [severity]="message.severity"
            [text]="message.text"
            [styleClass]="'w-full mb-3 py-3 border-round-lg'"
        />
    </ng-container>

    <p-message *ngIf="info.blockFound" severity="success" styleClass="w-full mb-4 py-4 border-round-xl"
        text="Today is your lucky day! Your device has found a block ðŸŽ‰">
    </p-message>

    <div class="grid">
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex flex-column justify-content-between">
                    <span class="block text-500 font-medium mb-3">Hashrate</span>

                    <ng-container *ngIf="!info.power_fault; else powerFault">
                        <div class="flex align-items-baseline gap-2 mb-3">
                            <span class="text-900 font-medium text-2xl">
                                {{info.hashRate | hashSuffix}}
                            </span>
                            <span class="text-500 text-xs"
                                pTooltip="Hash errors as reported by the ASIC. A small number errors every few seconds is normal. Frequency changes, agressive overclocking, low voltage or a bad power supply can significantly increase the error rate."
                                tooltipPosition="bottom">
                                Error: {{info.hashrateMonitor.errorCount}}
                            </span>
                        </div>

                        <div>
                            Average:
                            <span class="text-green-500 font-medium">
                                {{getHashrateAverage() | hashSuffix}}
                            </span>
                        </div>
                        <div class="text-500 text-xs" *ngIf="info.expectedHashrate">
                            Expected: {{info.expectedHashrate | hashSuffix}}
                        </div>
                    </ng-container>

                    <ng-template #powerFault>
                        <span class="text-red-500">
                            Not available - Power fault
                        </span>
                    </ng-template>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Efficiency</span>
                        <div class="text-900 font-medium text-2xl flex align-items-center gap-2">
                            <span *ngIf="!info.power_fault">
                                {{getEfficiency(info) | number: '1.2-2'}} J/Th
                            </span>
                            <span *ngIf="info.power_fault" class="text-red-500">
                                Not available - Power fault
                            </span>
                        </div>
                    </div>
                </div>

                <ng-container *ngIf="!info.power_fault">
                    Average:
                    <span class="text-green-500 font-medium">
                        {{getEfficiencyAverage() | number: '1.2-2'}} J/Th
                    </span>
                </ng-container>

                <div class="text-500 text-xs" *ngIf="!info.power_fault && info.expectedHashrate">
                    Expected: {{getExpectedEfficiency(info) | number: '1.2-2'}} J/Th
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Shares</span>
                        <div class="text-900 font-medium text-2xl">{{info.sharesAccepted | number: '1.0-0'}}
                        </div>
                    </div>
                </div>
                <div *ngIf="info.sharesRejected === 0">
                    <span class="text-red-500 font-medium">0 </span>
                    <span class="text-500">rejected</span>
                </div>
                <div *ngIf="info.sharesRejected > 0">
                    <div *ngFor="let sharesRejectedReason of getSortedRejectionReasons(info); trackBy: trackByReason">
                        <span
                        class="inline-block"
                        pTooltip="{{ getRejectionExplanation(sharesRejectedReason.message) }}"
                        [tooltipDisabled]="!getRejectionExplanation(sharesRejectedReason.message)"
                        tooltipPosition="bottom"
                        >
                        <span class="text-red-500 font-medium">
                            {{ sharesRejectedReason.count | number: '1.0-0' }}
                        </span>
                        <span class="text-500">
                            {{ sharesRejectedReason.message }}
                        </span>
                        ({{getShareRejectionPercentage(sharesRejectedReason, info) | number: '1.2-2'}} %)
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Best Difficulty</span>
                        <div class="text-900 font-medium text-2xl">{{info.bestDiff | diffSuffix}}
                            <span class="text-500 text-lg">all-time best</span>
                        </div>
                    </div>
                </div>
                <span class="text-900 font-medium">{{info.bestSessionDiff | diffSuffix}} </span>
                <span class="text-500">since system boot</span>
            </div>
        </div>

        <div class="col-12" *ngIf="!info.power_fault">
            <div class="card">
                <form [formGroup]="form">
                    <div class="flex flex-nowrap justify-content-between mb-3">
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY1Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY2Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                    </div>

                    <p-chart #chart id="chart" [data]="chartData" [options]="chartOptions"></p-chart>
                </form>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Power</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Power<span>{{info.power}} W</span>
                    </h6>
                    <p-progressBar [value]="(info.power / info.maxPower) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Input Voltage<span>{{info.voltage}} V</span>
                    </h6>
                    <div class="relative">
                        <p-progressBar [value]="(info.voltage / (info.nominalVoltage + .5)) * 100"
                            [styleClass]="'p-progressbar--thin'">
                            <ng-template pTemplate="content" let-value></ng-template>
                        </p-progressBar>

                        <!-- Conditional marker based on nominal voltage-->
                        <div class="absolute bg-white h-full top-0"
                            [style.left]="(info.nominalVoltage / (info.nominalVoltage + .5)) * 100 + '%'"
                            style="width: 3px;">
                            <small class="absolute text-white white-space-nowrap text-xs"
                                style="bottom: -1rem; transform: translateX(-50%)">
                                {{info.nominalVoltage}} V
                            </small>
                        </div>
                    </div>
                    <strong class="text-red-500" *ngIf="info.voltage < (info.nominalVoltage + .5) * 0.87">
                        Danger: Low Voltage
                    </strong>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        ASIC Frequency<span>{{info.frequency}} MHz</span>
                    </h6>
                    <p-progressBar [value]="(info.frequency / maxFrequency) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div>
                    <h6 class="flex justify-content-between mb-1">
                        Measured ASIC Voltage<span>{{info.coreVoltageActual}} V</span>
                    </h6>
                    <p-progressBar [value]="(info.coreVoltageActual / 1.8) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Heat</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.temp2 > 0; else singleTemp">
                            ASIC Temperature 1
                        </ng-container>
                        <ng-template #singleTemp>
                            ASIC Temperature
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.temp > 0; else noValue">
                                {{info.temp}} &deg;C
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp >= 70">
                        Danger: High Temperature
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.temp2 > 0">
                    <h6 class="flex justify-content-between mb-1">
                        ASIC Temperature 2
                        <span>
                            {{info.temp2}} &deg;C
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp2 / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp2 >= 70">
                        Danger: High Temperature
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.vrTemp > 0">
                    <h6 class="flex justify-content-between mb-1">
                        Voltage Regulator Temperature<span>{{info.vrTemp}} &deg;C</span>
                    </h6>
                    <p-progressBar [value]="(info.vrTemp / 120) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.vrTemp >= 105">
                        Danger: High Temperature
                    </strong>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">Fan</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        Fan Speed<span>{{info.fanspeed.toFixed(1)}} %</span>
                    </h6>
                    <p-progressBar [value]="info.fanspeed" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.fan2rpm > 0; else singleFan">
                            Fan 1 RPM
                        </ng-container>
                        <ng-template #singleFan>
                            Fan RPM
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.fanrpm > 0; else noValue">
                                {{info.fanrpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fanrpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                </div>

                <div *ngIf="info.fan2rpm > 0">
                    <h6 class="flex justify-content-between mb-1">
                        Fan 2 RPM
                        <span>
                            <ng-container *ngIf="info.fan2rpm > 0; else noValue">
                                {{info.fan2rpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fan2rpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <div class="flex flex-nowrap justify-content-between mb-3 relative">
                    <h4 class="mb-0">
                        Pool
                        <a
                            *ngIf="(quickLink$ | async) as quickLink"
                            [href]="quickLink"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="ml-1"
                            [attr.aria-label]="'Open pool dashboard in new tab'"
                            pTooltip="Open pool dashboard"
                            tooltipPosition="top"
                        >
                            <i class="pi pi-external-link"></i>
                        </a>
                    </h4>
                    <p-dropdown
                        [options]="(pools$ | async) ?? []"
                        [(ngModel)]="activePoolLabel"
                        optionLabel="label"
                        optionValue="value"
                        (onChange)="onPoolChange($event)"
                        styleClass="border-100 p-dropdown--small absolute right-0"
                    />
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>URL <i class="pi pi-info-circle text-xs px-1" pTooltip="{{ getPoolProtocolType(info) }}" tooltipPosition="top"></i></span>
                    </div>
                    <div>
                        <span>
                            {{ activePoolURL }}:{{activePoolPort}}
                        </span>
                    </div>
                </div>

                <div class="flex flex-nowrap ellipsis-magic overflow-hidden" pTooltip="{{activePoolUser}}" tooltipPosition="top">
                    <div class="col-fixed-width text-500">
                        <span>User</span>
                    </div>

                    <span class="start" sensitive-data>
                        {{ activePoolUser.substring(0, activePoolUser.length - 20) }}
                    </span>
                    <span class="end" sensitive-data>
                        {{ activePoolUser.substring(activePoolUser.length - 20) }}
                    </span>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span class="white-space-nowrap">Time <i class="pi pi-info-circle text-xs px-1" pTooltip="Time it takes for the pool to respond to a share"></i></span>
                    </div>
                    <div>
                        {{ info.responseTime }} ms
                    </div>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>Difficulty</span>
                    </div>
                    <div>
                        {{ info.poolDifficulty }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">Block Header</h4>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>Height</span>
                    </div>
                    <div>
                        {{ info.blockHeight }}
                    </div>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>Difficulty</span>
                    </div>
                    <div *ngIf="info.networkDifficulty">
                        {{ info.networkDifficulty | diffSuffix }}
                    </div>
                </div>

                <div class="flex flex-nowrap align-items-baseline">
                    <div class="col-fixed-width text-500">
                        <span>Scriptsig</span>
                    </div>
                    <div class="code">
                        {{ info.scriptsig }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">Hashrate Registers</h4>

                <table class="heatmap text-{{getAsicsAmount(info) <= 2 ? 'sm' : 'xs'}}">
                    <thead>
                        <tr>
                            <th class="text-left">#</th>
                            <ng-container *ngIf="getAsicDomainsAmount(info) as asicDomainsAmount">
                                <th *ngIf="asicDomainsAmount > 0" [attr.colspan]="asicDomainsAmount">
                                    {{ asicDomainsAmount == 1 ? "Domain" : "Domains" }}
                                </th>
                            </ng-container>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let asic of info.hashrateMonitor.asics; let i = index">
                            <td class="text-500 text-left cursor-pointer" pTooltip="ASIC {{ i + 1 }}" tooltipPosition="bottom">
                                {{ i + 1 }}
                            </td>
                            <td *ngFor="let domain of asic.domains"
                                [style.background]="getHeatmapColor(info, normalizeHashrate(domain))"
                                [style.height]="(getAsicsAmount(info) <= 2 ? '2rem' : null)"
                                class="text-center cursor-pointer"
                                pTooltip="{{ normalizeHashrate(domain) | hashSuffix }}"
                                tooltipPosition="bottom">
                                <span class="text-xs md:hidden">{{ normalizeHashrate(domain) | hashSuffix }}</span>
                            </td>
                            <td class="text-center cursor-pointer text-{{getDomainErrorColor(info, asic)}}-500" pTooltip="{{ normalizeHashrate(asic.error) | hashSuffix }}" tooltipPosition="bottom">
                                {{getDomainErrorPercentage(info, asic) | number: '1.2-2'}} %
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <app-confetti *ngIf="info.blockFound"></app-confetti>
</ng-container>
